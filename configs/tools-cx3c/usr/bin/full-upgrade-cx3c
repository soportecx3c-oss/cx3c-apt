#!/bin/bash
# full-upgrade-cx3c: actualización segura y limpia para Ubuntu/Debian
# by CX3C
#
# NOTA: Este script SOLO hace actualización del sistema.
#       Hardening/usuarios/SSH/políticas PAM se manejan en hard-users-cx3c.

set -euo pipefail
export DEBIAN_FRONTEND=noninteractive

# Dependencias mínimas
DEPS=("apt" "dpkg" "debconf-set-selections")

check_deps() {
  for dep in "${DEPS[@]}"; do
    if ! command -v "$dep" >/dev/null 2>&1; then
      echo "[+] Instalando dependencia faltante: $dep"
      apt-get update -y
      apt-get install -y "$dep"
    fi
  done
}

echo "[+] Verificando dependencias..."
check_deps

# Reinicio automático de servicios sin preguntar (pantalla rosa)
echo "[+] Configurando reinicio automático de servicios..."
echo "libc6 libraries/restart-without-asking boolean true" | debconf-set-selections || true

# Evitar prompts de needrestart (no-interactivo)
if [ -f /etc/needrestart/needrestart.conf ]; then
  # Forzar modo automatico sin que bash interprete  (set -u safe)
  sed -i -E 's|^[#[:space:]]*\\{restart\}.*|\ = "a";|' /etc/needrestart/needrestart.conf || true
fi

echo "[+] Actualizando lista de paquetes..."
apt-get update -y

echo "[+] Instalando actualizaciones normales..."
apt-get -o Dpkg::Options::="--force-confdef" \
        -o Dpkg::Options::="--force-confold" \
        upgrade -y

echo "[+] Realizando actualización completa..."
apt-get -o Dpkg::Options::="--force-confdef" \
        -o Dpkg::Options::="--force-confold" \
        full-upgrade -y

echo "[+] Limpiando paquetes no necesarios..."
apt-get autoremove -y
apt-get autoclean -y

echo "[✓] Actualización completa de CX3C terminada."

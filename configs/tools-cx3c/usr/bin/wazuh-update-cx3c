#!/bin/bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
umask 022

REPO_URL="https://github.com/soportecx3c-oss/cx3c-apt.git"
REPO_BRANCH="main"
OSSEC_DIR="/var/ossec"
DST_ETC="${OSSEC_DIR}/etc"
SRC_PREFIX="configs/wazuh/etc"

log(){ echo "[$(date -u +%FT%TZ)] $*"; }

need_root(){
  [ "$(id -u)" -eq 0 ] || { log "[ERR] Ejecuta como root."; exit 1; }
}

check_paths(){
  [ -d "$OSSEC_DIR" ] || { log "[ERR] No existe $OSSEC_DIR (Â¿Wazuh manager instalado?)"; exit 1; }
  [ -x "${OSSEC_DIR}/bin/wazuh-control" ] || { log "[ERR] No existe ${OSSEC_DIR}/bin/wazuh-control"; exit 1; }
  command -v git >/dev/null 2>&1 || { log "[ERR] falta git"; exit 1; }
}

mktemp_repo(){
  REPO_TEMP="$(mktemp -d /tmp/cx3c-repo.XXXXXX)"
  trap 'log "[INFO] cleanup: ${REPO_TEMP:-}"; timeout 10s rm -rf "${REPO_TEMP:-}" >/dev/null 2>&1 || log "[WARN] cleanup no completado: ${REPO_TEMP:-}"' EXIT
}

clone_repo(){
  log "[INFO] clonando repo (depth=1) -> $REPO_TEMP"
  git clone --depth 1 --branch "$REPO_BRANCH" "$REPO_URL" "$REPO_TEMP" >/dev/null
  COMMIT="$(git -C "$REPO_TEMP" rev-parse --short HEAD 2>/dev/null || true)"
  log "[INFO] repo commit: ${COMMIT:-unknown}"
}

backup_dst(){
  BK="${DST_ETC}/.cx3c_backup_$(date +%Y%m%d_%H%M%S)"
  mkdir -p "$BK"
  [ -f "${DST_ETC}/ossec.conf" ] && cp -a "${DST_ETC}/ossec.conf" "$BK/" || true
  [ -d "${DST_ETC}/rules" ] && cp -a "${DST_ETC}/rules" "$BK/" || true
  [ -d "${DST_ETC}/decoders" ] && cp -a "${DST_ETC}/decoders" "$BK/" || true
  log "[OK] backup creado: $BK"
}

sync_file_if_changed(){
  local src="$1" dst="$2"
  [ -f "$src" ] || { log "[ERR] falta src: $src"; exit 1; }
  if [ -f "$dst" ] && cmp -s "$src" "$dst"; then
    log "[OK] sin cambios: $(basename "$dst")"
    return 1
  fi
  cp -f "$src" "$dst"
  log "[OK] actualizado: $(basename "$dst")"
  return 0
}

sync_dir_glob(){
  local src_dir="$1" dst_dir="$2"
  mkdir -p "$dst_dir"
  local changed=0
  shopt -s nullglob
  for f in "$src_dir"/*.xml; do
    base="$(basename "$f")"
    if [ -f "$dst_dir/$base" ] && cmp -s "$f" "$dst_dir/$base"; then
      :
    else
      cp -f "$f" "$dst_dir/$base"
      changed=1
      log "[OK] actualizado: $(basename "$dst_dir")/$base"
    fi
  done
  shopt -u nullglob
  return $changed
}

sync_shared_groups(){
  local src_root="$1" dst_root="$2"
  [ -d "$src_root" ] || { log "[ERR] falta src shared: $src_root"; exit 1; }
  mkdir -p "$dst_root"
  local changed=0
  while IFS= read -r -d '' d; do
    g="$(basename "$d")"
    mkdir -p "$dst_root/$g"
    if command -v rsync >/dev/null 2>&1; then
      rsync -a "$d"/ "$dst_root/$g"/ >/dev/null
    else
      cp -a "$d"/. "$dst_root/$g"/
    fi
    changed=1
    log "[OK] synced shared/$g"
  done < <(find "$src_root" -mindepth 1 -maxdepth 1 -type d -print0)
  return $changed
}

restart_wazuh(){
  log "[INFO] reiniciando Wazuh..."
  "${OSSEC_DIR}/bin/wazuh-control" restart
  log "[OK] restart solicitado"
}

main(){
  need_root
  check_paths
  mktemp_repo
  clone_repo

  SRC_BASE="${REPO_TEMP}/${SRC_PREFIX}"
  [ -d "$SRC_BASE" ] || { log "[ERR] no existe en repo: $SRC_BASE"; exit 1; }

  backup_dst
  any_change=0

  log "[INFO] sync ossec.conf"
  if sync_file_if_changed "${SRC_BASE}/ossec.conf" "${DST_ETC}/ossec.conf"; then any_change=1; fi

  log "[INFO] sync rules/*.xml"
  if sync_dir_glob "${SRC_BASE}/rules" "${DST_ETC}/rules"; then any_change=1; fi

  log "[INFO] sync decoders/*.xml"
  if sync_dir_glob "${SRC_BASE}/decoders" "${DST_ETC}/decoders"; then any_change=1; fi

  log "[INFO] sync shared/* (1er nivel)"
  if sync_shared_groups "${SRC_BASE}/shared" "${DST_ETC}/shared"; then any_change=1; fi

  if [ "$any_change" -eq 1 ]; then
    restart_wazuh
  else
    log "[OK] no hubo cambios; no se reinicia Wazuh"
  fi

  log "[DONE] wazuh-update-cx3c"
}

main "$@"
